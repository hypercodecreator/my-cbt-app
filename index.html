<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ CBT</title>
    <style>
        /* ëª¨ë“  CSS ìŠ¤íƒ€ì¼ */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        #feedback-bar { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 8px; color: white; z-index: 100; }
        #feedback-bar.success { background-color: #28a745; }
        #feedback-bar.error { background-color: #dc3545; }
        .button { width: 100%; padding: 12px; font-size: 1rem; border-radius: 6px; cursor: pointer; margin-top: 10px; border: 1px solid #dee2e6; font-weight: 600; transition: all 0.2s ease-in-out; }
        .primary-button { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .secondary-button { background-color: #6c757d; color: white; border-color: #6c757d; }
        .light-button { background-color: #f8f9fa; color: #212529; }
        .small-button { width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0; }
        .icon-button { background: none; border: none; cursor: pointer; padding: 8px; font-size: 1.2rem; color: #6c757d; border-radius: 5px; line-height: 1; }
        .icon-button:hover { background-color: #e9ecef; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em; font-family: inherit; }
        .dynamic-field-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .management-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .learning-mode-selector { display: flex; }
        .learning-mode-selector .button { margin-top:0; border-radius: 0; }
        .learning-mode-selector .button:first-child { border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
        .learning-mode-selector .button:last-child { border-top-right-radius: 6px; border-bottom-right-radius: 6px; }
        .learning-mode-selector .button + .button { border-left-width: 0; }
        #question-list-container.split-view { display: flex; gap: 20px; }
        #tree-panel { flex: 1; min-width: 250px; border: 1px solid #eee; border-radius: 8px; padding: 10px; height: 500px; overflow-y: auto; }
        .question-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; gap: 15px; }
        .question-item-text { flex-grow: 1; cursor: pointer; }
        .question-item-text b { margin-right: 8px; }
        .question-item:hover { background-color: #f8f9fa; }
        #subject-list ul, #tree-panel ul { padding-left: 1em; list-style: none; }
        .node-header, .node { display: flex; align-items: center; cursor: pointer; padding: 5px; border-radius: 4px;}
        .node-header:hover, .node:hover { background-color: #f0f2f5; }
        .node.selected { background-color: #e0eaff; font-weight: bold; }
        .node-icon { margin-right: 8px; transition: transform 0.2s; display: inline-block; width: 1em; }
        .node-header.expanded > .node-icon { transform: rotate(90deg); }
        .subject-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 10px 10px 28px; }
        .subject-item:hover { background-color: #f8f9fa; border-radius: 4px;}
        .subject-item-buttons { display: flex; gap: 8px; flex-shrink: 0; align-items: center; }
        .option { padding: 15px 20px; border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .option:hover { background-color: #f8f9fa; }
        .option.selected { background-color: #e0eaff; border-color: #0d6efd; font-weight: bold; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 20; width: 90%; max-width: 500px; }
        #daily-progress-container { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center; font-size: 1.1em; display: flex; justify-content: center; align-items: center; gap: 10px; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            .management-controls { flex-direction: column; align-items: stretch; }
            #question-list-container.split-view { flex-direction: column; }
            #tree-panel { height: 250px; min-width: unset; }
            .subject-item { flex-direction: column; align-items: stretch; gap: 10px; }
            .subject-item-name-container { margin-right: 0; text-align: center; }
            .subject-item-buttons .button { width: 100%; box-sizing: border-box; }
            #quiz-body h4 { font-size: 1.2em; }
            .option { padding: 12px 15px; }
        }
        #calendar-wrapper { display: flex; gap: 5px; margin-bottom: 20px; }
        #weekday-labels { display: grid; grid-template-rows: repeat(7, 1fr); gap: 3px; font-size: 0.7em; color: #555; text-align: center; align-items: center; }
        #calendar-container { display: grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; gap: 3px; position: relative; }
        .calendar-day { width: 15px; height: 15px; background-color: #ebedf0; border-radius: 2px; }
        .calendar-day[data-level="1"] { background-color: #9be9a8; }
        .calendar-day[data-level="2"] { background-color: #40c463; }
        .calendar-day[data-level="3"] { background-color: #30a14e; }
        .calendar-day[data-level="4"] { background-color: #216e39; }
        .month-label { position: absolute; top: -18px; font-size: 0.7em; color: #555; }
        .login-options { text-align: right; font-size: 0.9em; margin-bottom: 15px; }
        .login-options a { color: #0d6efd; text-decoration: none; }
        .login-options a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div id="feedback-bar" class="hidden"></div>
        <div id="auth-container"></div>
        <div id="subject-view" class="hidden"></div>
        <div id="management-view" class="hidden"></div>
        <div id="quiz-view" class="hidden"></div>
        <div id="login-view" class="hidden"></div>
        <div id="signup-view" class="hidden"></div>
        <div id="add-edit-view" class="hidden"></div>
    </div>
    <div id="modal-container"></div>
    
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script>

 const firebaseConfig = {
  apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
  authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
  projectId: "my-cbt-app-2cdb9",
  storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
  messagingSenderId: "1091430877229",
  appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
};

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ì „ì—­ ë³€ìˆ˜
    let allSubjects = [];
    const views = ['subject-view', 'management-view', 'quiz-view', 'login-view', 'signup-view', 'add-edit-view'];
    let userSettings = { subjectTreeState: {}, subjectTreeDefaultState: 'expanded', listMode: 'paging' };
    let currentLearningMode = 'list';
    let currentSubjectId, currentSubjectData, allQuestionsForSubject = [];
    let quizQuestions = [], selectedOption, currentQuizIndex = 0, quizScore = 0;
    let currentPage = 1;
    const itemsPerPage = 20;
    let isLoading = false;

    // ==================================
    // ## ì•± ì´ˆê¸°í™” ë° í™”ë©´ ë Œë”ë§ ##
    // ==================================
    document.addEventListener('DOMContentLoaded', () => {
        window.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
            }
        });

        // ë·° ì´ˆê¸° HTML ì„¤ì •
        document.getElementById('login-view').innerHTML = `<h2>ë¡œê·¸ì¸</h2><div class="form-group"><label for="login-email">ì´ë©”ì¼</label><input type="email" id="login-email"></div><div class="form-group"><label for="login-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="login-password"></div><div class="login-options"><a href="#" onclick="showPasswordResetModal()">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</a></div><button class="button primary-button" onclick="logIn()">ë¡œê·¸ì¸</button><button class="button light-button" onclick="showView('login-view')">ì·¨ì†Œ</button>`;
        document.getElementById('auth-container').innerHTML = `<div id="logged-out-view"><button class="button light-button" onclick="showView('login-view')">ë¡œê·¸ì¸</button><button class="button primary-button" onclick="showView('signup-view')">íšŒì›ê°€ì…</button></div><div id="logged-in-view" class="hidden"><span id="user-email"></span><button class="button secondary-button" onclick="logOut()">ë¡œê·¸ì•„ì›ƒ</button></div>`;
        document.getElementById('subject-view').innerHTML = `<h2>ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</h2><div id="daily-progress-container"></div><div id="calendar-wrapper"><div id="weekday-labels"></div><div id="calendar-container"></div></div><div id="goal-setting-form-container" class="hidden" style="background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 20px;"><h4>ì˜¤ëŠ˜ì˜ ëª©í‘œ ì„¤ì •</h4><div class="form-group"><label for="daily-goal">í’€ ë¬¸ì œ ìˆ˜</label><input type="number" id="daily-goal" min="1"></div><div style="display: flex; gap: 10px;"><button class="button light-button" onclick="toggleGoalSettingForm()">ì·¨ì†Œ</button><button class="button primary-button" onclick="saveDailyGoal()">ì €ì¥</button></div></div><div id="subject-controls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><input type="search" id="subject-search" placeholder="í•™ë¬¸/í•™ê¸°/ê³¼ëª©ëª… ê²€ìƒ‰..." onkeyup="filterSubjectTree()" style="width:50%;"><div id="subject-tree-actions" style="display:flex; gap:5px;"><button class="button light-button small-button" onclick="expandAllNodes()">ëª¨ë‘ í¼ì¹˜ê¸°</button><button class="button light-button small-button" onclick="collapseAllNodes()">ëª¨ë‘ ì ‘ê¸°</button><button class="icon-button" onclick="showTreeSettingsModal()" title="ê¸°ë³¸ ë³´ê¸° ì„¤ì •">âš™ï¸</button></div></div><div id="subject-list" style="border: 1px solid #eee; border-radius: 8px; padding: 10px;"></div><button class="button primary-button" onclick="showSubjectForm()">+ ìƒˆ ê³¼ëª© ì¶”ê°€</button>`;
        document.getElementById('management-view').innerHTML = `<h2 id="management-header"></h2><div class="management-controls"><div class="mode-controls-group" style="display: flex; align-items: center; gap: 10px;"><div id="learning-mode-selector" class="learning-mode-selector"></div><div id="list-mode-toggle-container"></div></div><div style="display:flex; gap:10px; margin-top:0;"><button class="button light-button" style="width:auto;" onclick="showBulkAddModal()">+ ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€</button><button class="button primary-button" style="width: auto;" onclick="showFullEditView()">+ ìƒˆ ë¬¸ì œ ì¶”ê°€</button></div></div><div id="question-list-container"></div><div id="pagination-container" style="text-align: center; margin-top: 20px;"></div><button class="button light-button" onclick="showView('subject-view')" style="margin-top: 20px;">â†©ï¸ ê³¼ëª© ì„ íƒìœ¼ë¡œ</button>`;
        document.getElementById('signup-view').innerHTML = `<h2>íšŒì›ê°€ì…</h2><div class="form-group"><label for="signup-email">ì´ë©”ì¼</label><input type="email" id="signup-email"></div><div class="form-group"><label for="signup-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="signup-password"></div><button class="button primary-button" onclick="signUp()">íšŒì›ê°€ì…</button><button class="button light-button" onclick="showView('subject-view')">ì·¨ì†Œ</button>`;
        let addEditHTML = `<h2 id="add-edit-header"></h2><input type="hidden" id="editing-question-id"><h4>1. ë¬¸ì œ ì •ë³´ (í•„ìˆ˜)</h4><div class="form-group"><label for="q-text">ë¬¸ì œ ë‚´ìš©</label><textarea id="q-text" rows="3"></textarea></div><div class="form-group"><label for="q-answer">ì •ë‹µ</label><input type="text" id="q-answer"></div><div class="form-group"><label for="q-explanation">í•´ì„¤</label><textarea id="q-explanation" rows="3"></textarea></div><hr><h4>2. ëª©ì°¨ ì •ë³´ (10ë‹¨ê³„)</h4>`;
        for (let i = 1; i <= 10; i++) { addEditHTML += `<div class="form-group"><label for="q-level${i}">${i}ë‹¨ê³„</label><input type="text" id="q-level${i}"></div>`; }
        addEditHTML += `<hr><h4>3. ê¸°ì¶œ ì •ë³´ (ì‹¤ì „ í•™ìŠµìš©)</h4><div class="form-group"><label for="q-examYear">ì—°ë„</label><input type="text" id="q-examYear" placeholder="ì˜ˆ: 2024"></div><div class="form-group"><label for="q-examRound">íšŒì°¨</label><input type="text" id="q-examRound" placeholder="ì˜ˆ: 1íšŒ"></div><hr><h4>4. ê°ê´€ì‹ ë³´ê¸° (ì„ íƒ)</h4><div id="q-options-container"></div><button class="button light-button small-button" onclick="addDynamicField('option')">+ ë³´ê¸° ì¶”ê°€</button><hr><h4>5. í‚¤ì›Œë“œ/íƒœê·¸ (ê²€ìƒ‰ìš©)</h4><div id="q-keywords-container"></div><button class="button light-button small-button" onclick="addDynamicField('keyword')">+ í‚¤ì›Œë“œ ì¶”ê°€</button><div id="q-tags-container"></div><button class="button light-button small-button" onclick="addDynamicField('tag')">+ íƒœê·¸ ì¶”ê°€</button><div id="q-metatags-container"></div><button class="button light-button small-button" onclick="addDynamicField('metatag')">+ ë©”íƒ€íƒœê·¸ ì¶”ê°€</button><div style="display:flex; gap:10px; margin-top:20px;"><button class="button light-button" onclick="showManagementView(false)">ì·¨ì†Œ</button><button id="save-full-btn" class="button primary-button">ì €ì¥</button></div>`;
        document.getElementById('add-edit-view').innerHTML = addEditHTML;

        // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
        auth.onAuthStateChanged((user) => {
            const loggedOutView = document.getElementById('logged-out-view');
            const loggedInView = document.getElementById('logged-in-view');
            
            if (user) {
                if(loggedInView) {
                    document.getElementById('user-email').textContent = `${user.email}ë‹˜`;
                    loggedInView.classList.remove('hidden');
                }
                if(loggedOutView) loggedOutView.classList.add('hidden');
                initializeApp(user);
            } else {
                if(loggedInView) loggedInView.classList.add('hidden');
                if(loggedOutView) loggedOutView.classList.remove('hidden');
                
                userSettings = { subjectTreeState: {}, subjectTreeDefaultState: 'expanded', listMode: 'paging' };
                const subjectList = document.getElementById('subject-list');
                if(subjectList) subjectList.innerHTML = `<p style="text-align:center; padding: 20px;">ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</p>`;
                showView('login-view');
            }
        });
    });

    // ==================================
    // ## í•µì‹¬ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ##
    // ==================================

    function getTodayDateString() { const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
    function showView(viewId) { closeModal(); views.forEach(id => { const el = document.getElementById(id); if (el) el.classList.toggle('hidden', id !== viewId); }); }
    function showFeedback(message, type = 'success') { const feedbackBar = document.getElementById('feedback-bar'); if (!feedbackBar) return; feedbackBar.textContent = message; feedbackBar.className = type; setTimeout(() => { feedbackBar.className = 'hidden'; }, 3000); }  
    // ==================================
    // ## ì¸ì¦ ë° ì•± ì‹œì‘ í•¨ìˆ˜ ##
    // ==================================
    async function initializeApp(user) {
        await loadUserSettings(user.uid);
        await displayDailyProgress(); // âœ¨ ì˜¬ë°”ë¥¸ í•¨ìˆ˜ ì´ë¦„ìœ¼ë¡œ ìˆ˜ì •
        await renderLearningCalendar();
        await loadSubjects();
        showView('subject-view');
    }

    async function loadUserSettings(userId) {
        const userDocRef = db.collection('users').doc(userId);
        try {
            const doc = await userDocRef.get();
            if (doc.exists && doc.data().settings) {
                userSettings = doc.data().settings;
                if (!userSettings.subjectTreeState) userSettings.subjectTreeState = {};
                if (!userSettings.subjectTreeDefaultState) userSettings.subjectTreeDefaultState = 'expanded';
                if (!userSettings.listMode) userSettings.listMode = 'paging';
            } else {
                userSettings = { subjectTreeState: {}, subjectTreeDefaultState: 'expanded', listMode: 'paging' };
            }
        } catch (error) { console.error("ì‚¬ìš©ì ì„¤ì • ë¡œë”© ì¤‘ ì˜¤ë¥˜:", error); userSettings = { subjectTreeState: {}, subjectTreeDefaultState: 'expanded', listMode: 'paging' }; }
    }
    async function saveUserSettings() { const user = auth.currentUser; if (!user) return; const userDocRef = db.collection('users').doc(user.uid); try { await userDocRef.set({ settings: userSettings }, { merge: true }); } catch (error) { console.error("Error saving user settings:", error); } }
    async function signUp() { try { await auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value); } catch (e) { showFeedback(e.message, 'error'); } }
    async function logIn() { try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); } catch (e) { showFeedback(e.message, 'error'); } }
    function logOut() { auth.signOut(); }

    // ==================================
    // ## ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ ##
    // ==================================
    function showPasswordResetModal() {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.innerHTML = `<div class="modal-backdrop" onclick="closeModal()"></div><div class="modal"><h3>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h3><p style="font-size: 0.9em; color: #555; margin-bottom: 15px;">ê°€ì…í•˜ì‹  ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì‹œë©´ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</p><div class="form-group"><label for="reset-email">ì´ë©”ì¼</label><input type="email" id="reset-email"></div><div style="display: flex; gap: 10px;"><button class="button light-button" onclick="closeModal()">ì·¨ì†Œ</button><button class="button primary-button" onclick="sendPasswordReset()">ì „ì†¡</button></div></div>`;
    }

    async function sendPasswordReset() {
        const email = document.getElementById('reset-email').value.trim();
        if (!email) {
            showFeedback('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }
        try {
            await auth.sendPasswordResetEmail(email);
            closeModal();
            showFeedback('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'success');
        } catch (error) {
            console.error("Error sending password reset email:", error);
            showFeedback(error.message, 'error');
        }
    }

    // ==================================
    // ## í•™ìŠµ ë‹¬ë ¥ ê´€ë ¨ í•¨ìˆ˜ ##
    // ==================================
    async function renderLearningCalendar() {
        const user = auth.currentUser;
        if (!user) return;

        const calendarContainer = document.getElementById('calendar-container');
        const weekdayContainer = document.getElementById('weekday-labels');
        calendarContainer.innerHTML = '';
        weekdayContainer.innerHTML = '';

        // âœ¨ ìš”ì¼ ë¼ë²¨ ì¶”ê°€ (ì¼, ìˆ˜, ê¸ˆ)
        const weekdays = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        weekdays.forEach((day, i) => {
            if (i % 2 === 0) { // í™€ìˆ˜ ë²ˆì§¸ ìš”ì¼ë§Œ í‘œì‹œ (ì¼, ìˆ˜, ê¸ˆ)
                const dayLabel = document.createElement('div');
                dayLabel.textContent = day;
                weekdayContainer.appendChild(dayLabel);
            } else {
                weekdayContainer.appendChild(document.createElement('div')); // ì§ìˆ˜ ë²ˆì§¸ëŠ” ë¹ˆ ì¹¸
            }
        });

        // 1. 1ë…„ì¹˜ í•™ìŠµ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
        const oneYearAgoStr = `${oneYearAgo.getFullYear()}-${String(oneYearAgo.getMonth() + 1).padStart(2, '0')}-${String(oneYearAgo.getDate()).padStart(2, '0')}`;

        const progressMap = new Map();
        try {
            const snapshot = await db.collection('users').doc(user.uid).collection('dailyProgress')
                .where(firebase.firestore.FieldPath.documentId(), ">=", oneYearAgoStr)
                .get();
            snapshot.forEach(doc => {
                progressMap.set(doc.id, doc.data().solved || 0);
            });
        } catch (error) {
            console.error("Error fetching learning history:", error);
        }

        // 2. ë‹¬ë ¥ ê²©ì ìƒì„±
        const today = new Date();
        let currentDate = new Date(oneYearAgo);
        let currentMonth = -1;
        let weekIndex = 0;

        // ì²« ë‚ ì§œì˜ ìš”ì¼ì„ ê³„ì‚°í•˜ì—¬ ë¹ˆ ì¹¸ ì±„ìš°ê¸°
        const firstDayOfWeek = currentDate.getDay();
        for (let i = 0; i < firstDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day';
            emptyDay.style.visibility = 'hidden';
            calendarContainer.appendChild(emptyDay);
        }

        // 1ë…„ì¹˜ ë‚ ì§œ ì±„ìš°ê¸°
        while (currentDate <= today) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';

            const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
            const solvedCount = progressMap.get(dateStr) || 0;

            // 3. í‘¼ ë¬¸ì œ ìˆ˜ì— ë”°ë¼ ìƒ‰ìƒ ë ˆë²¨ ê²°ì •
            let level = 0;
            if (solvedCount > 0 && solvedCount <= 5) level = 1;
            else if (solvedCount > 5 && solvedCount <= 10) level = 2;
            else if (solvedCount > 10 && solvedCount <= 15) level = 3;
            else if (solvedCount > 15) level = 4;

            if (solvedCount > 0) {
                dayElement.setAttribute('data-level', level);
            }
            dayElement.title = `${dateStr}: ${solvedCount} ë¬¸ì œ`;

            calendarContainer.appendChild(dayElement);
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }

    // ==================================
    // ## ì˜¤ëŠ˜ì˜ ëª©í‘œ & ìŠ¤íŠ¸ë¦­ & ë‹¬ë ¥ í•¨ìˆ˜ ##
    // ==================================
    function toggleGoalSettingForm() { const formContainer = document.getElementById('goal-setting-form-container'); formContainer.classList.toggle('hidden'); }
    async function displayDailyProgress() {
        const user = auth.currentUser; if (!user) return;
        const today = getTodayDateString();
        const progressDocRef = db.collection('users').doc(user.uid).collection('dailyProgress').doc(today);
        let solved = 0; let goal = userSettings.dailyGoal || 20; let streak = userSettings.currentStreak || 0;
        try { const doc = await progressDocRef.get(); if (doc.exists) { solved = doc.data().solved || 0; goal = doc.data().goal || goal; } } catch (error) { console.error("Error fetching daily progress:", error); }
        const container = document.getElementById('daily-progress-container');
        container.innerHTML = `<span>ì˜¤ëŠ˜ì˜ ëª©í‘œ: ${solved} / ${goal} ë¬¸ì œ</span> <span style="margin-left: 15px;">ğŸ”¥ ${streak}ì¼ ì—°ì† í•™ìŠµ ì¤‘!</span> <button class="icon-button" onclick="toggleGoalSettingForm()">âœï¸</button>`;
        document.getElementById('daily-goal').value = goal;
    }

    async function saveDailyGoal() {
        const user = auth.currentUser; if (!user) return;
        const newGoal = document.getElementById('daily-goal').value;
        if (!newGoal || newGoal < 1) { showFeedback('ì˜¬ë°”ë¥¸ ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error'); return; }
        const today = getTodayDateString();
        const progressDocRef = db.collection('users').doc(user.uid).collection('dailyProgress').doc(today);
        try {
            await progressDocRef.set({ goal: Number(newGoal) }, { merge: true });
            toggleGoalSettingForm();
            await displayDailyProgressAndStreak();
            showFeedback('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } catch (error) { console.error("Error saving daily goal:", error); showFeedback('ëª©í‘œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); }
    }

    async function updateDailyProgress(problemsSolved) {
        const user = auth.currentUser; if (!user || problemsSolved === 0) return;
        const today = getTodayDateString();
        const progressDocRef = db.collection('users').doc(user.uid).collection('dailyProgress').doc(today);
        try {
            await progressDocRef.update({ solved: firebase.firestore.FieldValue.increment(problemsSolved) });
        } catch (error) {
            if (error.code === 'not-found') { const goal = userSettings.dailyGoal || 20; await progressDocRef.set({ goal: goal, solved: problemsSolved });
            } else { console.error("Error updating progress:", error); }
        }
        await updateStreak();
        await displayDailyProgressAndStreak();
    }

    async function updateStreak() {
        const user = auth.currentUser; if (!user) return;
        const today = new Date(); const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
        const todayStr = getTodayDateString();
        const yesterdayStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, '0')}-${String(yesterday.getDate()).padStart(2, '0')}`;
        const lastStudyDay = userSettings.lastStudyDay; let currentStreak = userSettings.currentStreak || 0;
        if (lastStudyDay === todayStr) { return; } else if (lastStudyDay === yesterdayStr) { currentStreak++; } else { currentStreak = 1; }
        userSettings.currentStreak = currentStreak;
        userSettings.lastStudyDay = todayStr;
        await saveUserSettings();
    }

    async function renderLearningCalendar() {
        const user = auth.currentUser; if (!user) return;
        const calendarContainer = document.getElementById('calendar-container');
        const weekdayContainer = document.getElementById('weekday-labels');
        calendarContainer.innerHTML = ''; weekdayContainer.innerHTML = '';
        const weekdays = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        weekdays.forEach((day, i) => { if (i % 2 !== 0) { const dayLabel = document.createElement('div'); dayLabel.textContent = day; weekdayContainer.appendChild(dayLabel); } else { weekdayContainer.appendChild(document.createElement('div')); } });
        const oneYearAgo = new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
        const oneYearAgoStr = `${oneYearAgo.getFullYear()}-${String(oneYearAgo.getMonth() + 1).padStart(2, '0')}-${String(oneYearAgo.getDate()).padStart(2, '0')}`;
        const progressMap = new Map();
        try {
            const snapshot = await db.collection('users').doc(user.uid).collection('dailyProgress').where(firebase.firestore.FieldPath.documentId(), ">=", oneYearAgoStr).get();
            snapshot.forEach(doc => { progressMap.set(doc.id, doc.data().solved || 0); });
        } catch (error) { console.error("Error fetching learning history:", error); }
        const today = new Date(); let currentDate = new Date(oneYearAgo); let currentMonth = -1; let weekIndex = 0;
        const firstDayOfWeek = currentDate.getDay();
        for (let i = 0; i < firstDayOfWeek; i++) { const emptyDay = document.createElement('div'); emptyDay.className = 'calendar-day'; emptyDay.style.visibility = 'hidden'; calendarContainer.appendChild(emptyDay); }
        while (currentDate <= today) {
            if (currentDate.getMonth() !== currentMonth) {
                currentMonth = currentDate.getMonth();
                const monthLabel = document.createElement('div');
                monthLabel.className = 'month-label';
                monthLabel.textContent = currentDate.toLocaleString('default', { month: 'short' });
                monthLabel.style.left = `${weekIndex * 18}px`;
                calendarContainer.appendChild(monthLabel);
            }
            const dayElement = document.createElement('div'); dayElement.className = 'calendar-day';
            const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
            const solvedCount = progressMap.get(dateStr) || 0;
            let level = 0;
            if (solvedCount > 0 && solvedCount <= 5) level = 1;
            else if (solvedCount > 5 && solvedCount <= 10) level = 2;
            else if (solvedCount > 10 && solvedCount <= 15) level = 3;
            else if (solvedCount > 15) level = 4;
            if (solvedCount > 0) { dayElement.setAttribute('data-level', level); }
            dayElement.title = `${dateStr}: ${solvedCount} ë¬¸ì œ`;
            calendarContainer.appendChild(dayElement);
            currentDate.setDate(currentDate.getDate() + 1);
            if (currentDate.getDay() === 0) { weekIndex++; }
        }
    }

    // ==================================
    // ## ê³¼ëª© ê´€ë¦¬ í•¨ìˆ˜ ##
    // ==================================
    async function loadSubjects() { const listDiv = document.getElementById('subject-list'); listDiv.innerHTML = 'ê³¼ëª© ë¡œë”© ì¤‘...'; try { const snapshot = await db.collection('subjects').get(); allSubjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderSubjectTree(); } catch (error) { console.error("ê³¼ëª© ë¡œë”© ì¤‘ ì˜¤ë¥˜:", error); } }
    function filterSubjectTree() { const filterText = document.getElementById('subject-search').value; renderSubjectTree(filterText); }
    function renderSubjectTree(filterText = '') {
        const lowerCaseFilter = filterText.toLowerCase().trim();
        const filteredSubjects = lowerCaseFilter ? allSubjects.filter(s => (s.discipline && s.discipline.toLowerCase().includes(lowerCaseFilter)) || (s.semester && s.semester.toLowerCase().includes(lowerCaseFilter)) || (s.name && s.name.toLowerCase().includes(lowerCaseFilter))) : allSubjects;
        const treeData = buildSubjectTreeData(filteredSubjects);
        const container = document.getElementById('subject-list');
        let html = '<ul>';
        const sortedDisciplines = Object.keys(treeData).sort();
        if (sortedDisciplines.length === 0 && !filterText) { container.innerHTML = `<p style="text-align:center; color:#888; padding: 20px;">ì•„ì§ ë“±ë¡ëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ê³¼ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>`; return; }
        if (sortedDisciplines.length === 0 && filterText) { container.innerHTML = `<p style="text-align:center; color:#888; padding: 20px;">'${filterText}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`; return; }
        for (const discipline of sortedDisciplines) {
            const disciplineState = userSettings.subjectTreeState[discipline];
            const isExpanded = !!filterText || (disciplineState ? disciplineState === 'expanded' : userSettings.subjectTreeDefaultState === 'expanded');
            html += `<li><div class="node-header ${isExpanded ? 'expanded' : ''}" onclick="toggleNode(this)"><span class="node-icon">â–¶</span><span class="node-name">${discipline}</span></div><ul class="${isExpanded ? '' : 'hidden'}">`;
            const sortedSemesters = Object.keys(treeData[discipline].semesters).sort();
            for (const semester of sortedSemesters) {
                const semesterState = userSettings.subjectTreeState[semester];
                const isSemesterExpanded = !!filterText || (semesterState ? semesterState === 'expanded' : userSettings.subjectTreeDefaultState === 'expanded');
                html += `<li><div class="node-header ${isSemesterExpanded ? 'expanded' : ''}" onclick="toggleNode(this)"><span class="node-icon">â–¶</span><span class="node-name">${semester}</span></div><ul class="${isSemesterExpanded ? '' : 'hidden'}">`;
                treeData[discipline].semesters[semester].sort((a,b) => a.name.localeCompare(b.name)).forEach(subject => { html += `<li>${getSubjectItemHTML(subject)}</li>`; });
                html += `</ul></li>`;
            }
            treeData[discipline].noSemester.sort((a,b) => a.name.localeCompare(b.name)).forEach(subject => { html += `<li>${getSubjectItemHTML(subject)}</li>`; });
            html += `</ul></li>`;
        }
        html += `</ul>`;
        container.innerHTML = html;
    }
    function buildSubjectTreeData(subjects) { const tree = {}; subjects.forEach(subject => { const discipline = subject.discipline || 'ë¯¸ì§€ì • í•™ë¬¸'; const semester = subject.semester || null; if (!tree[discipline]) tree[discipline] = { semesters: {}, noSemester: [] }; if (semester) { if (!tree[discipline].semesters[semester]) tree[discipline].semesters[semester] = []; tree[discipline].semesters[semester].push(subject); } else { tree[discipline].noSemester.push(subject); } }); return tree; }
    function getSubjectItemHTML(subject) { return `<div class="subject-item"><div class="subject-item-name-container"><span class="subject-item-name">${subject.name} (${subject.questionCount || 0}ë¬¸ì œ)</span></div><div class="subject-item-buttons"><button class="button primary-button" onclick="startQuiz('${subject.id}')">í€´ì¦ˆ ì‹œì‘</button><button class="button secondary-button" onclick="manageSubject('${subject.id}')">ë¬¸ì œ ê´€ë¦¬</button><button class="edit-btn" onclick="showSubjectForm('${subject.id}')">âœï¸</button><button class="delete-btn" onclick="deleteSubject('${subject.id}', '${subject.name}')">ğŸ—‘ï¸</button></div></div>`; }
    function toggleNode(element) { const isNowExpanded = element.classList.toggle('expanded'); const subList = element.nextElementSibling; if (subList && subList.tagName === 'UL') { subList.classList.toggle('hidden'); } const nodeName = element.querySelector('.node-name').textContent; userSettings.subjectTreeState[nodeName] = isNowExpanded ? 'expanded' : 'collapsed'; saveUserSettings(); }
    function expandAllNodes() { document.querySelectorAll('#subject-list .node-header').forEach(header => { header.classList.add('expanded'); if(header.nextElementSibling) header.nextElementSibling.classList.remove('hidden'); const nodeName = header.querySelector('.node-name').textContent; userSettings.subjectTreeState[nodeName] = 'expanded'; }); saveUserSettings(); }
    function collapseAllNodes() { document.querySelectorAll('#subject-list .node-header').forEach(header => { header.classList.remove('expanded'); if(header.nextElementSibling) header.nextElementSibling.classList.add('hidden'); const nodeName = header.querySelector('.node-name').textContent; userSettings.subjectTreeState[nodeName] = 'collapsed'; }); saveUserSettings(); }
    function showSubjectForm(subjectId = null) { const isEditing = !!subjectId; const subject = isEditing ? allSubjects.find(s => s.id === subjectId) : {}; const modalContainer = document.getElementById('modal-container'); modalContainer.innerHTML = `<div class="modal-backdrop" onclick="closeModal()"></div><div class="modal"><h3>${isEditing ? 'ê³¼ëª© ìˆ˜ì •' : 'ìƒˆ ê³¼ëª© ì¶”ê°€'}</h3><div class="form-group"><label for="subject-discipline">í•™ë¬¸ (ì˜ˆ: ì‘ê¸‰êµ¬ì¡°ì‚¬, ìê²©ì¦)</label><input type="text" id="subject-discipline" value="${subject.discipline || ''}" list="disciplines-list"><datalist id="disciplines-list">${[...new Set(allSubjects.map(s => s.discipline).filter(Boolean))].map(d => `<option value="${d}"></option>`).join('')}</datalist></div><div class="form-group"><label for="subject-semester">í•™ê¸° (ì„ íƒ ì‚¬í•­, ì˜ˆ: 1-2, 2-1)</label><input type="text" id="subject-semester" value="${subject.semester || ''}"></div><div class="form-group"><label for="subject-name">ê³¼ëª©ëª…</label><input type="text" id="subject-name" value="${subject.name || ''}"></div><div style="display: flex; gap: 10px;"><button class="button light-button" onclick="closeModal()">ì·¨ì†Œ</button><button class="button primary-button" onclick="saveSubject('${subjectId || ''}')">ì €ì¥</button></div></div>`; }
    function closeModal() { document.getElementById('modal-container').innerHTML = ''; }
    async function saveSubject(subjectId) { const data = { name: document.getElementById('subject-name').value.trim(), discipline: document.getElementById('subject-discipline').value.trim(), semester: document.getElementById('subject-semester').value.trim() }; if (!data.name || !data.discipline) { showFeedback('í•™ë¬¸ê³¼ ê³¼ëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.', 'error'); return; } try { if (subjectId) { await db.collection('subjects').doc(subjectId).update(data); } else { data.questionCount = 0; await db.collection('subjects').add(data); } closeModal(); await loadSubjects(); showFeedback(subjectId ? 'ê³¼ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒˆ ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); } catch (error) { console.error("ê³¼ëª© ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error); showFeedback('ê³¼ëª© ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); } }
    async function deleteSubject(subjectId, subjectName) { if (!confirm(`'${subjectName}' ê³¼ëª©ê³¼ ëª¨ë“  ë¬¸ì œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return; try { const questionsSnapshot = await db.collection('subjects').doc(subjectId).collection('questions').get(); const batch = db.batch(); questionsSnapshot.forEach(doc => batch.delete(doc.ref)); const subjectRef = db.collection('subjects').doc(subjectId); batch.delete(subjectRef); await batch.commit(); await loadSubjects(); showFeedback(`'${subjectName}' ê³¼ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success'); } catch (error) { console.error("ê³¼ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error); showFeedback('ê³¼ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); } }
    function showTreeSettingsModal() { const modalContainer = document.getElementById('modal-container'); const isDefaultExpanded = userSettings.subjectTreeDefaultState === 'expanded'; modalContainer.innerHTML = `<div class="modal-backdrop" onclick="closeModal()"></div><div class="modal"><h3>ê³¼ëª© íŠ¸ë¦¬ ê¸°ë³¸ ë³´ê¸° ì„¤ì •</h3><div class="form-group"><label><input type="radio" name="tree-default-state" value="expanded" ${isDefaultExpanded ? 'checked' : ''}> ëª¨ë‘ í¼ì¹˜ê¸°</label><label><input type="radio" name="tree-default-state" value="collapsed" ${!isDefaultExpanded ? 'checked' : ''}> ëª¨ë‘ ì ‘ê¸°</label></div><div style="display: flex; gap: 10px;"><button class="button light-button" onclick="closeModal()">ì·¨ì†Œ</button><button class="button primary-button" onclick="saveDefaultTreeState()">ì €ì¥</button></div></div>`; }
    function saveDefaultTreeState() { const selectedState = document.querySelector('input[name="tree-default-state"]:checked').value; userSettings.subjectTreeDefaultState = selectedState; userSettings.subjectTreeState = {}; saveUserSettings(); closeModal(); renderSubjectTree(); showFeedback('ê¸°ë³¸ ë³´ê¸° ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); }
        
    // ==================================
    // ## ë¬¸ì œ ê´€ë¦¬(Management View) í•¨ìˆ˜ ##
    // ==================================
    async function manageSubject(id) { const doc = await db.collection('subjects').doc(id).get(); if (!doc.exists) { showFeedback("ê³¼ëª© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error'); return; } currentSubjectId = id; currentSubjectData = doc.data(); currentPage = 1; await showManagementView(true); }
    function setLearningMode(mode) { currentLearningMode = mode; currentPage = 1; showManagementView(false); }
    function toggleListMode() { userSettings.listMode = (userSettings.listMode === 'paging') ? 'infinite' : 'paging'; saveUserSettings(); currentPage = 1; allQuestionsForSubject = []; showManagementView(true); }
    
    async function showManagementView(fetchData = false) {
        showView('management-view');
        document.getElementById('management-header').textContent = `[${currentSubjectData.name}] ë¬¸ì œ ê´€ë¦¬`;
        const container = document.getElementById('question-list-container');
        document.getElementById('learning-mode-selector').innerHTML = `<button class="button ${currentLearningMode === 'list' ? 'primary-button' : 'light-button'}" onclick="setLearningMode('list')">ì „ì²´ ëª©ë¡</button><button class="button ${currentLearningMode === 'topic' ? 'primary-button' : 'light-button'}" onclick="setLearningMode('topic')">ëª©ì°¨ë³„</button><button class="button ${currentLearningMode === 'exam' ? 'primary-button' : 'light-button'}" onclick="setLearningMode('exam')">íšŒì°¨ë³„</button><button class="button ${currentLearningMode === 'keyword' ? 'primary-button' : 'light-button'}" onclick="setLearningMode('keyword')">í‚¤ì›Œë“œë³„</button>`;
        
        if (fetchData) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">ë¬¸ì œ ëª©ë¡ ë¡œë”© ì¤‘...</div>';
            const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
            allQuestionsForSubject = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        container.innerHTML = ''; container.className = '';
        document.getElementById('pagination-container').innerHTML = '';
        if (allQuestionsForSubject.length === 0) { container.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
        
        if (currentLearningMode === 'list') {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedQuestions = allQuestionsForSubject.slice(startIndex, startIndex + itemsPerPage);
            renderProblemList(container, paginatedQuestions, true, startIndex);
            renderPagination(allQuestionsForSubject.length);
        } else {
            container.className = 'split-view';
            container.innerHTML = `<div id="tree-panel"></div><div id="problem-list-panel"><p style="color:#888; text-align:center;">â† ì™¼ìª½ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p></div>`;
            let levels;
            if (currentLearningMode === 'topic') { levels = Array.from({length: 10}, (_, i) => `level${i + 1}`); }
            else if (currentLearningMode === 'exam') { levels = ['examYear', 'examRound']; }
            else if (currentLearningMode === 'keyword') { levels = ['keywords', 'tags', 'metatags']; }
            const treeData = buildTreeData(allQuestionsForSubject, levels);
            renderTree(treeData, levels);
        }
    }

    function renderProblemList(container, questions, isInitialLoad = true, startIndex = 0) {
    let listContainer;
    if (isInitialLoad) {
        container.innerHTML = '';
        listContainer = document.createElement('div');
        listContainer.id = 'problem-list-wrapper';
        container.appendChild(listContainer);
    } else {
        listContainer = container.querySelector('#problem-list-wrapper');
    }
    if (!listContainer) return;
    
    questions.forEach((q, index) => {
        const item = document.createElement('div');
        item.className = 'question-item';
        
        // 1. (ìƒëŒ€ ë²ˆí˜¸)
        const relativeNumber = startIndex + index + 1; 
        
        // 2. [ì ˆëŒ€ ë²ˆí˜¸] (qidê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
        // âœ¨ qidê°€ ì—†ëŠ” ê¸°ì¡´ ë¬¸ì œë¥¼ ìœ„í•´ í‘œì‹œ ë°©ì‹ ìˆ˜ì •
        const absoluteNumberDisplay = q.qid ? `<b style="color: #0d6efd;">[${q.qid}]</b>` : ''; 
        
        // 3. ë‘ ë²ˆí˜¸ë¥¼ ëª¨ë‘ í‘œì‹œ
        item.innerHTML = `<div class="question-item-text" onclick="showFullEditView('${q.id}')">
                            ${absoluteNumberDisplay}
                            <span style="color: #888; font-size: 0.9em; margin-right: 5px;">(${relativeNumber})</span> 
                            ${q.text || '(ë‚´ìš© ì—†ìŒ)'}
                          </div>
                          <div class="question-item-actions">
                              <button class="button light-button small-button" onclick="showFullEditView('${q.id}')">ìˆ˜ì •</button>
                              <button class="button light-button small-button" onclick="deleteProblem('${q.id}')">ì‚­ì œ</button>
                          </div>`;
        listContainer.appendChild(item);
    });
}

    function renderPagination(totalItems) { const paginationContainer = document.getElementById('pagination-container'); paginationContainer.innerHTML = ''; const totalPages = Math.ceil(totalItems / itemsPerPage); if (totalPages <= 1) return; const prevButton = document.createElement('button'); prevButton.textContent = '<'; prevButton.className = 'button light-button small-button'; prevButton.disabled = currentPage === 1; prevButton.onclick = () => goToPage(currentPage - 1); paginationContainer.appendChild(prevButton); for (let i = 1; i <= totalPages; i++) { const pageButton = document.createElement('button'); pageButton.textContent = i; pageButton.className = 'button small-button ' + (i === currentPage ? 'primary-button' : 'light-button'); pageButton.onclick = () => goToPage(i); paginationContainer.appendChild(pageButton); } const nextButton = document.createElement('button'); nextButton.textContent = '>'; nextButton.className = 'button light-button small-button'; nextButton.disabled = currentPage === totalPages; nextButton.onclick = () => goToPage(currentPage + 1); paginationContainer.appendChild(nextButton); }
    
    function goToPage(pageNumber) {
        currentPage = pageNumber;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const paginatedQuestions = allQuestionsForSubject.slice(startIndex, startIndex + itemsPerPage);
        renderProblemList(document.getElementById('question-list-container'), paginatedQuestions, true, startIndex);
        renderPagination(allQuestionsForSubject.length);
    }
    
    // âœ¨âœ¨âœ¨ ì—¬ê¸°ì— ìˆë˜ ë¶ˆí•„ìš”í•œ ì½”ë“œ 3ì¤„ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤! âœ¨âœ¨âœ¨
    
    function buildTreeData(questions, levels) { const tree = {}; questions.forEach(q => { let currentLevel = tree; levels.forEach((levelKey) => { const value = Array.isArray(q[levelKey]) ? q[levelKey] : [q[levelKey] || `ë¯¸ì§€ì •`]; value.forEach(v => { if (!currentLevel[v]) { currentLevel[v] = { _children: {} }; } currentLevel = currentLevel[v]._children; }); }); }); return tree; }
    function renderTree(treeData, levels, level = 0, path = []) { const panel = document.getElementById('tree-panel'); if (level === 0) panel.innerHTML = ''; let html = '<ul>'; for (const key of Object.keys(treeData).sort()) { const currentPath = [...path, {key}]; const pathStr = JSON.stringify(currentPath).replace(/'/g, "&apos;"); html += `<li><div class="node" onclick='renderProblemListForNode(this, ${pathStr})'><span class="node-icon">â–¶</span>${key}</div>`; const children = treeData[key]._children; if (Object.keys(children).length > 0) { html += `<ul class="hidden">${renderTree(children, levels, level + 1, currentPath)}</ul>`; } html += `</li>`; } html += '</ul>'; if (level === 0) { panel.innerHTML = html; panel.onclick = function(e) { if(e.target.classList.contains('node-icon') || e.target.closest('.node')) { const nodeDiv = e.target.closest('.node'); const subList = nodeDiv.nextElementSibling; if(subList && subList.tagName === 'UL') { subList.classList.toggle('hidden'); nodeDiv.querySelector('.node-icon').style.transform = subList.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)'; } } }; } return html; }
    function renderProblemListForNode(element, path) {
        document.querySelectorAll('#tree-panel .node').forEach(node => node.classList.remove('selected'));
        if (element) element.classList.add('selected');
        const panel = document.getElementById('problem-list-panel');
        const levels = { topic: Array.from({length: 10}, (_, i) => `level${i + 1}`), exam: ['examYear', 'examRound'], keyword: ['keywords', 'tags', 'metatags'] }[currentLearningMode];
        const filteredQuestions = allQuestionsForSubject.filter(q => { return path.every((p, i) => { const levelKey = levels[i]; const value = q[levelKey]; return Array.isArray(value) ? (value || []).includes(p.key) : (value || 'ë¯¸ì§€ì •') === p.key; }); });
        renderProblemList(panel, filteredQuestions, true, 0);
    }
    
    function resetFullEditViewForm() {
        document.getElementById('add-edit-header').textContent = '';
        document.getElementById('editing-question-id').value = '';
        ['text', 'answer', 'explanation', 'examYear', 'examRound'].forEach(f => {
            const el = document.getElementById(`q-${f}`);
            if (el) el.value = '';
        });
        for(let i = 1; i <= 10; i++) {
            const el = document.getElementById(`q-level${i}`);
            if (el) el.value = '';
        }
        ['options', 'keywords', 'tags', 'metatags'].forEach(type => {
            const container = document.getElementById(`q-${type}-container`);
            if(container) container.innerHTML = '';
        });
    }

    function showFullEditView(questionId = null) {
        resetFullEditViewForm();
        showView('add-edit-view');
        const isEditing = !!questionId;
        const q = isEditing ? allQuestionsForSubject.find(q => q.id === questionId) : {};
        
        document.getElementById('add-edit-header').textContent = isEditing ? 'ë¬¸ì œ ìˆ˜ì •' : 'ìƒˆ ë¬¸ì œ ì¶”ê°€';
        document.getElementById('editing-question-id').value = q.id || '';
        
        document.getElementById('q-text').value = q.text || '';
        document.getElementById('q-answer').value = q.answer || '';
        document.getElementById('q-explanation').value = q.explanation || '';
        document.getElementById('q-examYear').value = q.examYear || '';
        document.getElementById('q-examRound').value = q.examRound || '';

        for (let i = 1; i <= 10; i++) {
            const el = document.getElementById(`q-level${i}`);
            if (el) el.value = q[`level${i}`] || '';
        }
        
        ['option', 'keyword', 'tag', 'metatag'].forEach(type => {
            const container = document.getElementById(`q-${type}s-container`);
            container.innerHTML = '';
            const items = q[type + 's'] || [];
            if (items.length === 0) {
                addDynamicField(type, '');
            } else {
                items.forEach(val => addDynamicField(type, val));
            }
        });

        document.getElementById('save-full-btn').onclick = () => saveFullUpdate(questionId);
    }

    function addDynamicField(type, value = '') { const container = document.getElementById(`q-${type}s-container`); if (!container) return; const newField = document.createElement('div'); newField.className = 'dynamic-field-group'; const count = container.children.length + 1; const placeholderText = type.charAt(0).toUpperCase() + type.slice(1); newField.innerHTML = `<span class="field-label">${count}.</span><input type="text" class="q-${type}" value="${value}" placeholder="${placeholderText}"><button type="button" class="icon-button" onclick="this.parentElement.remove()">ğŸ—‘ï¸</button>`; container.appendChild(newField); }

    async function saveFullUpdate(questionId) {
    try {
        const data = {
            text: document.getElementById('q-text').value.trim(),
            answer: document.getElementById('q-answer').value.trim(),
            explanation: document.getElementById('q-explanation').value.trim(),
            examYear: document.getElementById('q-examYear').value.trim(),
            examRound: document.getElementById('q-examRound').value.trim(),
            options: Array.from(document.querySelectorAll('.q-option')).map(i => i.value.trim()).filter(Boolean),
            keywords: Array.from(document.querySelectorAll('.q-keyword')).map(i => i.value.trim()).filter(Boolean),
            tags: Array.from(document.querySelectorAll('.q-tag')).map(i => i.value.trim()).filter(Boolean),
            metatags: Array.from(document.querySelectorAll('.q-metatag')).map(i => i.value.trim()).filter(Boolean),
        };

        for (let i = 1; i <= 10; i++) {
            const levelValue = document.getElementById(`q-level${i}`).value.trim();
            if (levelValue) {
                data[`level${i}`] = levelValue;
            } else if (questionId) {
                data[`level${i}`] = firebase.firestore.FieldValue.delete();
            }
        }

        if (!data.text || !data.answer) {
            showFeedback("ë¬¸ì œ ë‚´ìš©ê³¼ ì •ë‹µì€ í•„ìˆ˜ì…ë‹ˆë‹¤.", "error");
            return;
        }
        
        const subjectRef = db.collection('subjects').doc(currentSubjectId);

        if (questionId) {
            // [ê¸°ì¡´] ìˆ˜ì • ëª¨ë“œ
            await subjectRef.collection('questions').doc(questionId).update(data);
            showFeedback("ë¬¸ì œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        } else {
            // [ì‹ ê·œ] ì¶”ê°€ ëª¨ë“œ (íŠ¸ëœì­ì…˜ ì‚¬ìš©)
            await db.runTransaction(async (transaction) => {
                const subjectDoc = await transaction.get(subjectRef);
                const currentCount = subjectDoc.data().questionCount || 0;
                
                // âœ¨ ìƒˆ ë¬¸ì œì— ê³ ìœ  ID (qid) ë¶€ì—¬
                data.qid = currentCount + 1; 

                const newQuestionRef = subjectRef.collection('questions').doc();
                transaction.set(newQuestionRef, data);
                transaction.update(subjectRef, { questionCount: currentCount + 1 });
            });
            showFeedback("ìƒˆ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        }
        
        await showManagementView(true);

    } catch (error) {
        console.error("Firestore ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        showFeedback("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
    }
}

    function showBulkAddModal() {
    const modalContainer = document.getElementById('modal-container');
    modalContainer.innerHTML = `
        <div class="modal-backdrop" onclick="closeModal()"></div>
        <div class="modal">
            <h3>ì—¬ëŸ¬ ë¬¸ì œ í•œ ë²ˆì— ì¶”ê°€</h3>

            <div class="form-group">
                <label>ì…ë ¥ ë°©ì‹ ì„ íƒ</label>
                <div style="display: flex; gap: 15px; font-size: 0.9em;">
                    <label>
                        <input type="radio" name="bulk-format" value="keyword" checked>
                        ë¹ˆ ì¤„ë¡œ êµ¬ë¶„ (ì •ë‹µ:, í•´ì„¤: í‚¤ì›Œë“œ)
                    </label>
                    <label>
                        <input type="radio" name="bulk-format" value="delimiter">
                        í•œ ì¤„ì— í•œ ë¬¸ì œ (// ê¸°í˜¸ë¡œ êµ¬ë¶„)
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="bulk-questions-input">ë¬¸ì œ ëª©ë¡ ë¶™ì—¬ë„£ê¸°</label>
                <textarea id="bulk-questions-input" rows="10" placeholder="ìœ„ì—ì„œ ì„ íƒí•œ ë°©ì‹ì— ë§ê²Œ ë¬¸ì œ ë‚´ìš©ì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”."></textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="button light-button" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="button primary-button" onclick="saveBulkQuestions()">ì €ì¥</button>
            </div>
        </div>
    `;
}

    async function saveBulkQuestions() {
    const selectedFormat = document.querySelector('input[name="bulk-format"]:checked').value;
    const input = document.getElementById('bulk-questions-input').value.trim();
    if (!input) {
        showFeedback('ì¶”ê°€í•  ë¬¸ì œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    let questionsToAdd = [];
    let parseError = false;

    if (selectedFormat === 'keyword') {
        const questionBlocks = input.split(/\n\s*\n/).filter(block => block.trim() !== '');
        for (const block of questionBlocks) {
            const lines = block.split('\n');
            const answerIndex = lines.findIndex(line => line.includes('ì •ë‹µ:'));
            if (answerIndex === -1) {
                showFeedback(`'ì •ë‹µ:' í‚¤ì›Œë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: "${block.substring(0, 20)}..."`, 'error');
                parseError = true; break;
            }
            const text = lines.slice(0, answerIndex).join('\n').trim();
            const explanationIndex = lines.findIndex(line => line.includes('í•´ì„¤:'));
            let answer, explanation = '';
            if (explanationIndex > -1) {
                answer = lines.slice(answerIndex, explanationIndex).join('\n').replace('ì •ë‹µ:', '').trim();
                explanation = lines.slice(explanationIndex).join('\n').replace('í•´ì„¤:', '').trim();
            } else {
                answer = lines.slice(answerIndex).join('\n').replace('ì •ë‹µ:', '').trim();
            }
            if (!text || !answer) {
                 showFeedback(`í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤: "${block.substring(0, 20)}..."`, 'error');
                 parseError = true; break;
            }
            questionsToAdd.push({ text, answer, explanation });
        }
    } else {
        const lines = input.split('\n').filter(line => line.trim() !== '');
        for (const line of lines) {
            const parts = line.split('//').map(p => p.trim());
            const [text, answer, explanation = ''] = parts;
            if (!text || !answer) {
                showFeedback(`'//' í˜•ì‹ ì˜¤ë¥˜: ë¬¸ì œì™€ ì •ë‹µì€ í•„ìˆ˜ì…ë‹ˆë‹¤. ("${line.substring(0, 20)}...")`, 'error');
                parseError = true; break;
            }
            questionsToAdd.push({ text, answer, explanation });
        }
    }

    if (parseError || questionsToAdd.length === 0) {
        if (!parseError) showFeedback('ì¶”ê°€í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }

    // â–¼â–¼â–¼ ì €ì¥ ë¡œì§ì„ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ìˆ˜ì • â–¼â–¼â–¼
    try {
        const subjectRef = db.collection('subjects').doc(currentSubjectId);
        
        await db.runTransaction(async (transaction) => {
            const subjectDoc = await transaction.get(subjectRef);
            let currentCount = subjectDoc.data().questionCount || 0;

            questionsToAdd.forEach(qData => {
                currentCount++; // ì¹´ìš´íŠ¸ë¥¼ 1 ì¦ê°€ì‹œí‚¤ê³ 
                qData.qid = currentCount; // âœ¨ ìƒˆ ê³ ìœ  ID (qid)ë¡œ ë¶€ì—¬

                const newQuestionRef = subjectRef.collection('questions').doc();
                transaction.set(newQuestionRef, qData);
            });

            // ìµœì¢…ì ìœ¼ë¡œ ì¦ê°€ëœ ì´ ì¹´ìš´íŠ¸ë¥¼ ì—…ë°ì´íŠ¸
            transaction.update(subjectRef, { questionCount: currentCount });
        });
        
        closeModal();
        showFeedback(`${questionsToAdd.length}ê°œì˜ ë¬¸ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        await showManagementView(true);
    } catch (error) {
        console.error("ì—¬ëŸ¬ ë¬¸ì œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        showFeedback("ë¬¸ì œë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
    }
}

    async function deleteProblem(questionId) { if (!confirm("ì •ë§ë¡œ ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; try { const subjectRef = db.collection('subjects').doc(currentSubjectId); await subjectRef.collection('questions').doc(questionId).delete(); await subjectRef.update({ questionCount: firebase.firestore.FieldValue.increment(-1) }); showFeedback("ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success"); await showManagementView(true); } catch(error) { console.error(error); showFeedback("ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", 'error'); } }
    
    // ==================================
    // ## í€´ì¦ˆ ì‹¤í–‰ í•¨ìˆ˜ ##
    // ==================================
    async function startQuiz(id) {
        const doc = await db.collection('subjects').doc(id).get();
        if (!doc.exists) { showFeedback("ê³¼ëª© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error'); return; }
        currentSubjectId = id;
        currentSubjectData = doc.data();
        const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
        if (snapshot.empty) { showFeedback('í€´ì¦ˆë¥¼ ì‹œì‘í•˜ë ¤ë©´ ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸ì œê°€ í•„ìš”í•©ë‹ˆë‹¤.', 'error'); return; }
        quizQuestions = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort(() => 0.5 - Math.random());
        currentQuizIndex = 0;
        quizScore = 0;
        selectedOption = null;
        showView('quiz-view');
        displayCurrentQuiz();
    }

    function exitQuiz() {
        if (currentQuizIndex > 0) {
            updateDailyProgress(currentQuizIndex); // í˜„ì¬ê¹Œì§€ í‘¼ ë¬¸ì œ ìˆ˜ë¥¼ ë°˜ì˜
        }
        showView('subject-view');
    }

    function displayCurrentQuiz() {
        const quizView = document.getElementById('quiz-view');
        
        if (currentQuizIndex >= quizQuestions.length) {
            updateDailyProgress(quizQuestions.length);
            quizView.innerHTML = `...`; // (ê²°ê³¼ í™”ë©´ì€ ë™ì¼)
            return;
        }

        const q = quizQuestions[currentQuizIndex];
        const optionsHTML = (q.options && q.options.length > 0) 
            ? q.options.map(opt => `<div class="option">${opt}</div>`).join('')
            : '<div class="form-group"><label for="subjective-answer">ì •ë‹µ ì…ë ¥:</label><input type="text" id="subjective-answer"></div>';

        // âœ¨ 'í€´ì¦ˆ ì¤‘ë‹¨' ë²„íŠ¼ì´ exitQuiz()ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •
        quizView.innerHTML = `
            <div id="quiz-header">${currentQuizIndex + 1} / ${quizQuestions.length}</div>
            <div id="quiz-body">
                <h4>${q.text}</h4>
                <div class="options-container">${optionsHTML}</div>
            </div>
            <div id="quiz-footer">
                <div id="immediate-feedback"></div>
                <button id="submit-btn" class="button primary-button">ì •ë‹µ í™•ì¸</button>
                <button class="button light-button" onclick="exitQuiz()">â†©ï¸ í€´ì¦ˆ ì¤‘ë‹¨</button>
            </div>
        `;

        // âœ¨ ê°ê´€ì‹ ë³´ê¸° ì„ íƒ ì‹œ ì‹œê°ì  í”¼ë“œë°±ì„ ì£¼ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì • (ë¬¸ì œ 1 í•´ê²°)
        quizView.querySelectorAll('.option').forEach(el => {
            el.addEventListener('click', (e) => {
                // ëª¨ë“  ë³´ê¸°ì—ì„œ 'selected' ìŠ¤íƒ€ì¼ ì œê±°
                quizView.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                // í´ë¦­í•œ ë³´ê¸°ì—ë§Œ 'selected' ìŠ¤íƒ€ì¼ ì¶”ê°€
                e.currentTarget.classList.add('selected');
                selectedOption = e.currentTarget.textContent;
            });
        });

        document.getElementById('submit-btn').addEventListener('click', submitAnswer);
    }
    
    function submitAnswer() {
        const q = quizQuestions[currentQuizIndex];
        const feedbackDiv = document.getElementById('immediate-feedback');
        let userAnswer;
        if (q.options && q.options.length > 0) {
            const selectedEl = document.querySelector('.option.selected');
            if (!selectedEl) { showFeedback("ë³´ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", 'error'); return; }
            userAnswer = selectedEl.textContent;
        } else {
            const inputEl = document.getElementById('subjective-answer');
            if (!inputEl.value.trim()) { showFeedback("ì •ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error'); return; }
            userAnswer = inputEl.value.trim();
        }
        const isCorrect = userAnswer === q.answer;
        if (isCorrect) {
            quizScore++;
            feedbackDiv.className = 'feedback correct';
            feedbackDiv.innerHTML = `<p>ì •ë‹µì…ë‹ˆë‹¤!</p>`;
        } else {
            feedbackDiv.className = 'feedback incorrect';
            feedbackDiv.innerHTML = `<p>ì˜¤ë‹µì…ë‹ˆë‹¤. (ì •ë‹µ: ${q.answer})</p>`;
        }
        if(q.explanation) {
            feedbackDiv.innerHTML += `<div class="explanation">${q.explanation}</div>`;
        }
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.textContent = 'ë‹¤ìŒ ë¬¸ì œ â†’';
        submitBtn.onclick = () => {
            currentQuizIndex++;
            displayCurrentQuiz();
        };
    }
</script>
</body>
</html>